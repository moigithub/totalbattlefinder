unit Unit1;

interface

uses

  System.Math,

  MMSystem, Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtDlgs, Vcl.ExtCtrls, Vcl.StdCtrls, System.Threading,
  // ocv.highgui_c, ocv.core_c, ocv.core.types_c,
  // ocv.imgproc_c,
  // ocv.utils, ocv.imgproc.types_c,
  // Vcl.Imaging.jpeg, ocv.comp.View,
  //
  // ocv.comp.Types, ocv.comp.Source,
  //
  // ocv.objdetect_c,
  //
  // ocv.cls.highgui,
  // ocv.cls.core,
  // ocv.cls.contrib,
  // ocv.cls.Types, unit2
  OPENCVWrapper, unit3, Vcl.Samples.Spin;

type
  TForm1 = class(TForm)
    OpenPictureDialog1: TOpenPictureDialog;
    Timer1: TTimer;
    Panel1: TPanel;
    Button1: TButton;
    CheckBox1: TCheckBox;
    Edit1: TEdit;
    seInterval: TSpinEdit;
    Label1: TLabel;
    Memo1: TMemo;
    Image2: TImage;
    Image1: TImage;
    Label2: TLabel;
    Button3: TButton;
    Image3: TImage;
    procedure Button1Click(Sender: TObject);
    procedure seIntervalChange(Sender: TObject);
    procedure CheckBox1Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Timer1Timer(Sender: TObject);
  private
    { Private declarations }
    templateFileName: string;
  public
    { Public declarations }
  end;

const
  FileName = 'beep.m4a';

var
  Form1: TForm1;

implementation

{$R *.dfm}

procedure playBeep();
var
  filepath, soundfile: string;
begin
  filepath := ExtractFilePath(Application.ExeName);

  soundfile := filepath + FileName;
  if FileExists(soundfile) then
  begin
    PlaySound(pchar(soundfile), 0, SND_ASYNC or SND_FILENAME);

  end;

end;

procedure CaptureDesktopToBitmap(Bitmap: TBitmap);
var
  DC: HDC;
  ScreenWidth, ScreenHeight: integer;
begin
  ScreenWidth := Screen.Width div 2;
  ScreenHeight := Screen.Height div 2;

  Bitmap.Width := ScreenWidth;
  Bitmap.Height := ScreenHeight;
  Bitmap.PixelFormat := pf24bit;

  DC := GetDC(0); // Get the device context of the entire screen
  try
    BitBlt(Bitmap.Canvas.Handle, 0, 0, ScreenWidth, ScreenHeight, DC, 0, 0, SRCCOPY);
  finally
    ReleaseDC(0, DC);
  end;
end;

procedure TForm1.Button1Click(Sender: TObject);
var
  pict: TPicture;
begin
  if OpenPictureDialog1.Execute then
  begin
    pict := TPicture.Create;
    try
      pict.LoadFromFile(OpenPictureDialog1.FileName);
      Image1.Picture.Assign(pict);

      templateFileName := OpenPictureDialog1.FileName;
      Edit1.Text := templateFileName;

    finally
      pict.Free;
    end;

  end;
end;

procedure TForm1.Button3Click(Sender: TObject);
var

  matchCount: double;
  threshold: single;
begin
  threshold := 0.7;
  if templateFileName = '' then
    exit;

  matchCount := PerformTemplateMatching(templateFileName, Image2, threshold);
  Form1.Caption := matchCount.ToString;
  if matchCount > threshold then
    playBeep();
end;

procedure TForm1.CheckBox1Click(Sender: TObject);
begin
  Timer1.Enabled := CheckBox1.Checked;
end;

procedure TForm1.seIntervalChange(Sender: TObject);
begin
  Timer1.Interval := seInterval.Value;
end;

function IsAppFocused: Boolean;
begin
//  Result := (GetForegroundWindow = Application.Handle) and
  result:=(GetActiveWindow = Application.Handle);
end;

procedure TForm1.Timer1Timer(Sender: TObject);
begin

if IsAppFocused then exit;

  Button3.Click;
end;

end.
